<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">

<!--
The custom HP Service Manager Interrogator's task can fetch the status of the request from iiq, but there
is nothing built-in to the product.  See comments for status values below to understand what
the link is between what return and what's in HP Service Manager.
-->

<sailpoint>

  <Rule language='beanshell' name='tst_HPServiceManagerIntegrationRuleForChange' type='Integration'>
    <Description>
      Use this rule to customize the data loaded into the provisioningPlan's 
      integrationData object. The provisioningPlan and its integrationData 
      object are used by Velocity to populate values in the XML templates for 
      the web service calls.
    </Description>
    <Signature returnType='Attributes'>
      <Inputs>
        <Argument name='identity'>
          <Description>
            A sailpoint.object.Identity representing the person being remediated.
          </Description>
        </Argument>
        <Argument name='plan'>
          <Description>
            A sailpoint.object.ProvisioningPlan representing remediation.
          </Description>
        </Argument>
        <Argument name='context'>
          <Description>
            A sailpoint.api.SailPointContext object that can be used to 
            query the database to find the Rule.
          </Description>
        </Argument>
        <Argument name='log'>
          <Description>
            A Log object to help report and/or debug the Rule.
          </Description>
        </Argument>
      </Inputs>
    </Signature>
    <Source>
      <![CDATA[
      import java.util.ArrayList;
      import java.util.List;
      import sailpoint.object.Identity;
      
      Map map = (Map)plan.getIntegrationData();
      map.put("identityName", identity.getName());
      //System.out.println ("Plan: "  + plan.toXml());

      if (identity.getFirstname() != null)  {
        map.put("identityFirstname", identity.getFirstname());
      }

      if (identity.getLastname() != null)  {
        map.put("identityLastname", identity.getLastname());
      }
     
      List requesters = new ArrayList();
      List planRequesters = plan.getRequesters();
      if (planRequesters != null) {
        for (int i = 0 ; i < planRequesters.size() ; i++) {
          Identity req = (Identity)planRequesters.get(i);
          requesters.add(req.getDisplayableName());
          //System.out.println ("Requester: " + req.getDisplayableName()); 
        }
      } else
        requesters.add("IIQRequestor");
        map.put("requesters", requesters);
        map.put("sourceId", plan.getSourceId());
        map.put("sourceName", plan.getSourceName());
        map.put("sourceType", plan.getSourceType());
    ]]>
    </Source>
  </Rule>

  <IntegrationConfig name="tst_HPServiceManagerIntegrationForChange"
                   executor="sailpoint.integration.hpservicemanager.HPServiceManagerIntegrationExecutor"
                   roleSyncStyle="none">

    <PlanInitializer>
      <Reference class="sailpoint.object.Rule" name="tst_HPServiceManagerIntegrationRuleForChange"/>
    </PlanInitializer>
   
    <!--
      Connection params.  Can also include username and password for
      SOAP authentication.
    -->
    <Attributes>
      <Map>
        <!-- set this to true and we will save a provisioning request object
             which we will check to make sure that we don't send another provisioning
             request with the same things -->
        <entry key='saveProvisioningRequests' value='false'/>

        <!-- no reason not to handle all request types, but the resources won't have 
             support some by default.  TODO : think about adding the features -->
        <entry key='operations' value='Create,Modify,Delete,Enable,Unlock,SetPassword'/>

        <!-- date formatting for dateTime XML data type -->
        <entry key="dateFormat" value="yyyy-MM-dd'T'HH:mm:ss"/>
      
        <!-- authentication -->
		<entry key="username" value=""/>
		<entry key="password" value=""/>

        <!-- configuration maps for the different integration methods -->
		<entry key="enableChangeRequest" value="true"/>
        <entry key="provision">
          <value>
            <Map>
			  <entry key="endpoint" value="http://localhost:13080/SM/7/ws"/> <!-- e.g. http://ip_address or host_name:port_number/SM/7/ws -->
			  <entry key="namespace" value="http://schemas.hp.com/SM/7"/> <!-- mention it as per the WSDL file generated by the HP Service Manger-->
			  <entry key="prefix" value="ns"/> <!-- mention it as per the WSDL file generated by the HP Service Manger-->
			  <entry key="SOAPAction" value="Create"/> <!-- it will tells HP Service Manager what action should perform -->
			  <entry key="responseElement" value="ChangeID"/> <!-- attribute of a soap response which has the changeID number -->
			  <entry key="soapMessage">
			  <!-- SOAP Message Template -->
                <value>
                  <String><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns="http://schemas.hp.com/SM/7" xmlns:com="http://schemas.hp.com/SM/7/Common" xmlns:xm="http://www.w3.org/2005/05/xmlmime">
   <soapenv:Header/>
   <soapenv:Body>
      <ns:CreateChangeRequest attachmentInfo="False" attachmentData="False" ignoreEmptyElements="true" updateconstraint="">
         <ns:model query="">
            <ns:keys query="" updatecounter="">
               <!--Optional:-->
               <ns:ChangeID type="String" mandatory="" readonly=""></ns:ChangeID>
            </ns:keys>
            <ns:instance query="" uniquequery="" recordid="" updatecounter="">
               <ns:header type="Structure">
                  <!--Optional:-->
                  <ns:ChangeID type="String" mandatory="" readonly=""></ns:ChangeID>
                  <!--Optional:-->
                  <ns:Category type="String" mandatory="" readonly="">Software</ns:Category>
                  <!--Optional:-->
                  <ns:Status type="String" mandatory="" readonly=""></ns:Status>
                  <!--Optional:-->
                  <ns:ApprovalStatus type="String" mandatory="" readonly=""></ns:ApprovalStatus>
                  <!--Optional:-->
                  <ns:InitiatedBy type="String" mandatory="" readonly="">GENERAL, ADMIN</ns:InitiatedBy>
                  <!--Optional:-->
                  <ns:AssignedTo type="String" mandatory="" readonly=""></ns:AssignedTo>
                  <!--Optional:-->
                  <ns:AssignmentGroup type="String" mandatory="" readonly="">Service Desk</ns:AssignmentGroup>
                  <!--Optional:-->
                  <ns:ChangeCoordinator type="String" mandatory="" readonly=""></ns:ChangeCoordinator>
                  <!--Optional:-->
                  <ns:CoordinatorPhone type="String" mandatory="" readonly=""></ns:CoordinatorPhone>
                  <!--Optional:-->
                  <ns:PlannedStart type="DateTime" mandatory="" readonly=""></ns:PlannedStart>
                  <!--Optional:-->
                  <ns:PlannedEnd type="DateTime" mandatory="" readonly=""></ns:PlannedEnd>
                  <!--Optional:-->
                  <ns:Reason type="String" mandatory="" readonly=""></ns:Reason>
                  <!--Optional:-->
                  <ns:Phase type="String" mandatory="" readonly=""></ns:Phase>
                  <!--Optional:-->
                  <ns:RiskAssessment type="String" mandatory="" readonly="">3 - Moderate Risk</ns:RiskAssessment>
                  <!--Optional:-->
                  <ns:Priority type="String" mandatory="" readonly=""></ns:Priority>
                  <!--Optional:-->
                  <ns:DateEntered type="DateTime" mandatory="" readonly=""></ns:DateEntered>
                  <!--Optional:-->
                  <ns:Open type="Boolean" mandatory="" readonly=""></ns:Open>
                  <!--Optional:-->
                  <ns:BackoutDuration type="Duration" mandatory="" readonly=""></ns:BackoutDuration>
                  <!--Optional:-->
                  <ns:CloseTime type="DateTime" mandatory="" readonly=""></ns:CloseTime>
                  <!--Optional:-->
                  <ns:ExtProjectRef type="String" mandatory="" readonly=""></ns:ExtProjectRef>
                  <!--Optional:-->
                  <ns:RFCType2 type="String" mandatory="" readonly=""></ns:RFCType2>
                  <!--Optional:-->
                  <ns:Company type="String" mandatory="" readonly=""></ns:Company>
                  <!--Optional:-->
                 <!-- <ns:Title type="String" mandatory="" readonly="">needs more processor time 0000001</ns:Title> -->
				  <ns:Title type="String" mandatory="" readonly="">IdentityIQ provisioning request for: $provisioningPlan.integrationData.identityName    $!provisioningPlan.integrationData.identityRequestId</ns:Title>
                  <!--Optional:-->
                  <ns:Subcategory type="String" mandatory="" readonly=""></ns:Subcategory>
                  <!--Optional:-->
                  <ns:SLAAgreementID type="Int" mandatory="" readonly=""></ns:SLAAgreementID>
               </ns:header>
               <ns:description.structure type="Structure">
                  <!--Optional:-->
                  <ns:Description type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:Description type="String" mandatory="" readonly="">IdentityIQ provisioning request for: $provisioningPlan.integrationData.identityName    $!provisioningPlan.integrationData.identityRequestId</ns:Description>
                  </ns:Description>
                  <!--Optional:-->
                  <ns:OverallAssessment type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:OverallAssessment type="String" mandatory="" readonly=""></ns:OverallAssessment>
                  </ns:OverallAssessment>
                  <!--Optional:-->
                  <ns:BackoutMethod type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:BackoutMethod type="String" mandatory="" readonly=""></ns:BackoutMethod>
                  </ns:BackoutMethod>
               </ns:description.structure>
               <ns:middle type="Structure">
                  <!--Optional:-->
                  <ns:ConfigurationItem type="String" mandatory="" readonly=""></ns:ConfigurationItem>
                  <!--Optional:-->
                  <ns:Location type="String" mandatory="" readonly=""></ns:Location>
                  <!--Optional:-->
                  <ns:Misc1 type="String" mandatory="" readonly=""></ns:Misc1>
                  <!--Optional:-->
                  <ns:Misc2 type="String" mandatory="" readonly=""></ns:Misc2>
                  <!--Optional:-->
                  <ns:Misc3 type="String" mandatory="" readonly=""></ns:Misc3>
                  <!--Optional:-->
                  <ns:Misc4 type="String" mandatory="" readonly=""></ns:Misc4>
                  <!--Optional:-->
                  <ns:Misc5 type="String" mandatory="" readonly=""></ns:Misc5>
                  <!--Optional:-->
                  <ns:Misc6 type="String" mandatory="" readonly=""></ns:Misc6>
                  <!--Optional:-->
                  <ns:Misc7 type="String" mandatory="" readonly=""></ns:Misc7>
                  <!--Optional:-->
                  <ns:Misc8 type="String" mandatory="" readonly=""></ns:Misc8>
                  <!--Optional:-->
                  <ns:Misc9 type="String" mandatory="" readonly=""></ns:Misc9>
                  <!--Optional:-->
                  <ns:Misc10 type="String" mandatory="" readonly=""></ns:Misc10>
                  <!--Optional:-->
                  <ns:ScheduledDowntimeStart type="DateTime" mandatory="" readonly=""></ns:ScheduledDowntimeStart>
                  <!--Optional:-->
                  <ns:ScheduledDowntimeEnd type="DateTime" mandatory="" readonly=""></ns:ScheduledDowntimeEnd>
                  <!--Optional:-->
                  <ns:ScheduledOutageStart type="DateTime" mandatory="" readonly=""></ns:ScheduledOutageStart>
                  <!--Optional:-->
                  <ns:ScheduledOutageEnd type="DateTime" mandatory="" readonly=""></ns:ScheduledOutageEnd>
                  <!--Optional:-->
                  <ns:ActualOutageStart type="DateTime" mandatory="" readonly=""></ns:ActualOutageStart>
                  <!--Optional:-->
                  <ns:ActualOutageEnd type="DateTime" mandatory="" readonly=""></ns:ActualOutageEnd>
                  <!--Optional:-->
                  <ns:MiscArray1 type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:MiscArray1 type="String" mandatory="" readonly=""></ns:MiscArray1>
                  </ns:MiscArray1>
                  <!--Optional:-->
                  <ns:MiscArray2 type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:MiscArray2 type="String" mandatory="" readonly=""></ns:MiscArray2>
                  </ns:MiscArray2>
                  <!--Optional:-->
                  <ns:MiscArray3 type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:MiscArray3 type="String" mandatory="" readonly=""></ns:MiscArray3>
                  </ns:MiscArray3>
                  <!--Optional:-->
                  <ns:Assets type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:Assets type="String" mandatory="" readonly=""></ns:Assets>
                  </ns:Assets>
                  <!--Optional:-->
                  <ns:EstimateDescription type="String" mandatory="" readonly=""></ns:EstimateDescription>
                  <!--Optional:-->
                  <ns:EstimatePrice type="String" mandatory="" readonly=""></ns:EstimatePrice>
                  <!--Optional:-->
                  <ns:ActualCost type="String" mandatory="" readonly=""></ns:ActualCost>
                  <!--Optional:-->
                  <ns:ActualPrice type="String" mandatory="" readonly=""></ns:ActualPrice>
               </ns:middle>
               <ns:close type="Structure">
                  <!--Optional:-->
                  <ns:ClosureCode type="Decimal" mandatory="" readonly=""></ns:ClosureCode>
                  <!--Optional:-->
                  <ns:ClosingComments type="Array">
                     <!--Zero or more repetitions:-->
                     <ns:ClosingComments type="String" mandatory="" readonly=""></ns:ClosingComments>
                  </ns:ClosingComments>
               </ns:close>
               <!--Optional:-->
               <ns:Urgency type="String" mandatory="" readonly="">3 - Average</ns:Urgency>
               <!--Optional:-->
               <ns:Impact type="String" mandatory="" readonly="">4 - User</ns:Impact>
               <!--Optional:-->
               <ns:ReleaseType type="String" mandatory="" readonly=""></ns:ReleaseType>
               <!--Optional:-->
               <ns:Service type="String" mandatory="" readonly="">Applications</ns:Service>
               <!--Optional:-->
               <ns:ReleaseCandidate type="Boolean" mandatory="" readonly=""></ns:ReleaseCandidate>
               <!--Optional:-->
               <ns:RequestedEndDate type="DateTime" mandatory="" readonly="">2014-11-28T20:05:12</ns:RequestedEndDate>
               <!--Optional:-->
               <ns:LocationFullName type="String" mandatory="" readonly=""></ns:LocationFullName>
               <!--Optional:-->
               <ns:Emergency type="Boolean" mandatory="" readonly=""></ns:Emergency>
               <!--Optional:-->
               <ns:ClosureComments type="Array">
                  <!--Zero or more repetitions:-->
                  <ns:ClosureComments type="String" mandatory="" readonly=""></ns:ClosureComments>
               </ns:ClosureComments>
               <!--Optional:-->
               <ns:ApprovalComments type="Array">
                  <!--Zero or more repetitions:-->
                  <ns:ApprovalComments type="String" mandatory="" readonly=""></ns:ApprovalComments>
               </ns:ApprovalComments>
               <!--Optional:-->
               <ns:attachments/>
            </ns:instance>
            <!--Optional:-->
            <ns:messages>
               <!--Zero or more repetitions:-->
               <com:message severity="" module=""></com:message>
            </ns:messages>
         </ns:model>
      </ns:CreateChangeRequest>
   </soapenv:Body>
</soapenv:Envelope>
 ]]>
	              </String>
			    </value>
			  </entry>
			</Map>
		  </value>
        </entry>

        <!-- mapping of HP Service Manager request status values to the
             possible status values in the IIQ (RequestStatus class) -->
       <entry key="statusMap">
          <value>
            <Map>
              <entry key="Closed" value="committed" />
			  <entry key="Pending Other" value="queued" />
			  <entry key="Referred" value="queued" />
			  <entry key="Replaced Problem" value="queued" />
			  <entry key="Resolved" value="committed" />
			  <entry key="Open" value="queued" />
              <entry key="Accepted" value="queued" />
			  <entry key="Rejected" value="queued" />
			  <entry key="Work In Progress" value="queued" />
		      <entry key="Pending Customer" value="queued" />
			  <entry key="Pending Vendor" value="queued" />
              <entry key="Pending Change" value="queued" />
			  <entry key="initial" value="queued" />
            </Map>
          </value>
        </entry> 

        <entry key="getRequestStatus">
          <value>
            <Map>
          	  <entry key="endpoint" value="http://localhost:13080/SM/7/ws"/> <!-- e.g. http://ip_address or host_name:port_number/SM/7/ws -->
			  <entry key="namespace" value="http://schemas.hp.com/SM/7"/> <!-- mention it as per the WSDL file generated by the HP Service Manger-->     
			  <entry key="prefix" value="ns"/>
			  <entry key="SOAPAction" value="Retrieve"/>
              <entry key="responseElement" value="Status"/>
			  <entry key="closureInfoResponseElement" value="ClosureCode"/>
              <entry key="soapMessage">
              <!-- XML template -->
                <value>
                  <String><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns="http://schemas.hp.com/SM/7" xmlns:com="http://schemas.hp.com/SM/7/Common" xmlns:xm="http://www.w3.org/2005/05/xmlmime">
   <soapenv:Header/>
   <soapenv:Body>
      <ns:RetrieveChangeRequest attachmentInfo="False" attachmentData="False" ignoreEmptyElements="True" updatecounter="" handle="" count="" start="">
         <ns:model query="">
            <ns:keys query="" updatecounter="">
               <ns:ChangeID type="String" mandatory="" readonly="">$requestID</ns:ChangeID>
            </ns:keys>
            <ns:instance/>
         </ns:model>
      </ns:RetrieveChangeRequest>
   </soapenv:Body>
</soapenv:Envelope>
]]>
                  </String>
                </value>
              </entry>
            </Map>
          </value>
        </entry>
      </Map>
    </Attributes>
   
    <ManagedResources>
      <ManagedResource>
        <ApplicationRef>
          <Reference class="sailpoint.object.Application" name="Harbor"/>
        </ApplicationRef>
      </ManagedResource>
    </ManagedResources>
    
  </IntegrationConfig>

    <!-- This relies on sailpoint.custom.HPServiceManagerInterrogator which
       we can use to test getStatus until it's baked into the ui -->

  <TaskDefinition name='HP Service Manager Interrogator For Change' type='Generic' executor='sailpoint.custom.HPServiceManagerInterrogator'>
    <Attributes>
      <Map>
        <entry key="HPServiceManagerConfigForChange" value="tst_HPServiceManagerIntegrationForChange"/>
      </Map>
    </Attributes>
    <Description>
      Query HP Service Manager for status of IIQ-generated tickets
    </Description>
    <Signature>
      <Inputs>
        <Argument name='ticketId' type='string' multi='false' required='true'>
          <Prompt>HP Service Manager ticket ID</Prompt>
        </Argument>
      </Inputs>
      <Returns>
        <Argument name='ticketStatus' type='String'>
          <Prompt>Ticket Status:</Prompt>
        </Argument>
      </Returns>
    </Signature>
  </TaskDefinition>

</sailpoint>
